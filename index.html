<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fahrschüler-Rating</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1877F2">
  <style>
    body { font-family:sans-serif; background:#0f172a; color:#e2e8f0; margin:0; padding:1rem; }
    h1 { font-size:1.4rem; }
    select, input, button, textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #334155; background:#1e293b; color:#e2e8f0; margin-bottom:10px; }
    button { background:#1877F2; border:none; color:white; font-weight:bold; }
    .section { background:#1e293b; padding:1rem; border-radius:12px; margin-bottom:1rem; }
    .rating-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; gap:10px; }
    .stars button { font-size:1.3rem; background:none; border:none; color:#ccc; padding:0 3px; }
    .stars .on { color:#fbbf24; }
    label { display:block; margin-bottom:0.2rem; font-size:0.9rem; }
    .entry { border:1px solid #334155; padding:10px; border-radius:8px; margin-bottom:10px; background:#0f172a; }
    footer { font-size:0.8rem; opacity:0.6; margin-top:2rem; }
  </style>
</head>
<body>
<h1>Fahrschüler-Rating v2.1</h1>

<div class="section">
  <label>Fahrschüler auswählen:</label>
  <select id="studentSelect"></select>

  <label>Neuer Schüler:</label>
  <input id="newStudentName" placeholder="Max Mustermann">

  <label>Führerscheinklasse:</label>
  <select id="newStudentKlasse">
    <option value="AM">AM</option><option value="A1">A1</option><option value="A2">A2</option>
    <option value="A">A</option><option value="B">B</option><option value="BE">BE</option>
    <option value="C1">C1</option><option value="C1E">C1E</option><option value="C">C</option>
    <option value="CE">CE</option><option value="D1">D1</option><option value="D1E">D1E</option>
    <option value="D">D</option><option value="DE">DE</option><option value="L">L</option><option value="T">T</option>
  </select>
  <button onclick="addStudent()">Schüler hinzufügen</button>
</div>

<div class="section">
  <label>Datum:</label>
  <input type="date" id="datum">

  <div id="ratingsContainer"></div>

  <label>Zusätzliche Notiz:</label>
  <textarea id="notiz" rows="3"></textarea>

  <button onclick="saveRating()">Bewertung speichern</button>
</div>

<div class="section">
  <label>Alle Bewertungen:</label>
  <div id="log"></div>
</div>

<footer>Alle Daten bleiben lokal gespeichert.</footer>

<script>
const kategorien = [
  "Pünktlichkeit", "Fahrzeugbedienung", "Spiegel/Schulterblick",
  "Vorfahrt & Regeln", "Parken", "Abbiegen/Einordnen",
  "Autobahn", "Sicherheitsgefühl", "Selbstständigkeit", "Theorie-Wissen"
];

let students = JSON.parse(localStorage.getItem('fsr_v2_students')||'[]');
let ratings = JSON.parse(localStorage.getItem('fsr_v2_ratings')||'[]');
let currentStars = {};

function $(id){ return document.getElementById(id); }

function renderStudents(){
  const sel = $("studentSelect");
  sel.innerHTML = '';
  students.forEach((s,i) => {
    const o = document.createElement("option");
    o.value = s.id;
    o.textContent = s.name + " (" + s.klasse + ")";
    sel.appendChild(o);
  });
}

function addStudent(){
  const name = $("newStudentName").value.trim();
  const klasse = $("newStudentKlasse").value;
  if (!name) return alert("Name fehlt");
  const id = crypto.randomUUID();
  students.push({id, name, klasse});
  localStorage.setItem('fsr_v2_students', JSON.stringify(students));
  $("newStudentName").value = '';
  renderStudents();
}

function renderRatingsForm(){
  const wrap = $("ratingsContainer");
  wrap.innerHTML = '';
  kategorien.forEach(kat => {
    currentStars[kat] = 3;
    const div = document.createElement("div");
    div.className = "rating-row";
    div.innerHTML = `<label style="flex:1">${kat}</label><div class="stars" id="s_${kat}" style="flex:2"></div>`;
    wrap.appendChild(div);
    renderStars(kat);
  });
}

function renderStars(kat){
  const el = $("s_" + kat);
  el.innerHTML = '';
  for (let i=1;i<=5;i++){
    const b = document.createElement("button");
    b.innerText = i <= currentStars[kat] ? "★" : "☆";
    if (i <= currentStars[kat]) b.classList.add("on");
    b.onclick = () => { currentStars[kat] = i; renderStars(kat); };
    el.appendChild(b);
  }
}

function saveRating(){
  const studentId = $("studentSelect").value;
  const datum = $("datum").value || new Date().toISOString().slice(0,10);
  const notiz = $("notiz").value.trim();
  const eintrag = {
    id: crypto.randomUUID(),
    studentId, datum, notiz,
    kategorien: {...currentStars}
  };
  ratings.push(eintrag);
  localStorage.setItem('fsr_v2_ratings', JSON.stringify(ratings));
  $("notiz").value = '';
  renderLog();
}

function renderLog(){
  const wrap = $("log");
  wrap.innerHTML = '';
  ratings.slice().reverse().forEach(r => {
    const s = students.find(s => s.id === r.studentId);
    const div = document.createElement("div");
    div.className = "entry";
    const header = `${r.datum} – ${s ? s.name : "??"} (${s?.klasse || "?"})`;
    const catlines = Object.entries(r.kategorien).map(([k,v]) => `${k}: ${"★".repeat(v)}${"☆".repeat(5-v)}`).join("<br>");
    div.innerHTML = `<b>${header}</b><br>${catlines}${r.notiz ? "<br><i>"+r.notiz+"</i>":""}`;
    wrap.appendChild(div);
  });
}

renderStudents();
renderRatingsForm();
renderLog();
</script>
</body>
</html>
